#!/bin/bash
# Version sync pre-commit hook
# Install: cp scripts/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

VERSION_FILES=(
  "package.json"
  "frontend/package.json"
  "installer/package.json"
  "wails.json"
)

# Check if any version file is staged
staged_files=$(git diff --cached --name-only)
has_version_file=false

for file in "${VERSION_FILES[@]}"; do
  if echo "$staged_files" | grep -qx "$file"; then
    has_version_file=true
    break
  fi
done

if [ "$has_version_file" = false ]; then
  exit 0
fi

# Extract versions from all 4 files
v_root=$(jq -r '.version' package.json)
v_frontend=$(jq -r '.version' frontend/package.json)
v_installer=$(jq -r '.version' installer/package.json)
v_wails=$(jq -r '.info.productVersion' wails.json)

# Compare all versions
mismatch=false
if [ "$v_root" != "$v_frontend" ] || [ "$v_root" != "$v_installer" ] || [ "$v_root" != "$v_wails" ]; then
  mismatch=true
fi

if [ "$mismatch" = true ]; then
  echo "ERROR: Version mismatch detected!"
  echo ""
  echo "  package.json:          $v_root"
  echo "  frontend/package.json: $v_frontend"
  echo "  installer/package.json: $v_installer"
  echo "  wails.json:            $v_wails"
  echo ""
  echo "All version files must have the same version."
  echo "Update all files before committing."
  exit 1
fi

exit 0
